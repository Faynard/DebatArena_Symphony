<link rel="stylesheet" href="{{ asset('css/navbar.css') }}">

<nav class="navbar">
    <!-- Logo -->
    <div class="navbar__logo">
        <a href="{{ path('app_debate_index') }}">
            <img src="{{ asset('image/logo.png') }}" alt="Debate Arena Logo" class="navbar__logo-img">
            <span>Debate Arena</span>
        </a>
    </div>

    <!-- Recherche -->
    <div class="navbar__search">
        <form id="search-form" action="{{ path('app_debate_search') }}" method="get" autocomplete="off">
            <input type="text" id="debate-search" name="q" placeholder="Rechercher un d√©bat..." />
            <button type="submit">
                <img src="{{ asset('image/loupe.svg') }}" alt="Rechercher" class="search-icon" />
            </button>
        </form>
        <div id="search-results" class="search-dropdown"></div>
    </div>

    <a href="{{ path('app_debate_advanced_search') }}" class="btn-advanced-search">
        üîç Recherche avanc√©e
    </a>

    <!-- Actions Utilisateur -->
    <div class="navbar__actions">
        <a href="{{ path('app_debate_new') }}" class="btn-create-debate">
            Ajouter un d√©bat
        </a>

        {% if app.user %}
            <a href="{{ path('app_user_show', {'id': app.user.id}) }}" class="login-button">
                <img src="{{ asset('image/profil.svg') }}" class="profile-icon">
            </a>
        {% else %}
            <a href="{{ path('app_login') }}" class="login-button">
                <img src="{{ asset('image/profil.svg') }}" class ="profile-icon">
            </a>
        {% endif %}

        <div class="navbar__lang">
            <img src="{{ asset('image/translate.svg') }}" alt="Changer de langue" class="lang-icon" />
            <div class="language-switcher" id="lang-switcher">
                <a href="{{ path(app.request.attributes.get('_route'), app.request.query.all|merge({'_locale': 'fr'})) }}">Fran√ßais</a>
                <a href="{{ path(app.request.attributes.get('_route'), app.request.query.all|merge({'_locale': 'en'})) }}">English</a>
            </div>
        </div>

    </div>
</nav>

<!-- JS Recherche & Langue -->
<script>
    const resultsContainer = document.getElementById('search-results');

    document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('debate-search');
        const form = document.getElementById('search-form');
        let timeout = null;

        input.addEventListener('input', () => {
            clearTimeout(timeout);
            const query = input.value.trim();

            if (query.length < 2) {
                resultsContainer.innerHTML = '';
                resultsContainer.style.display = 'none';
                return;
            }

            resultsContainer.innerHTML = '<div class="search-loading">Recherche en cours...</div>';
            resultsContainer.style.display = 'block';

            timeout = setTimeout(() => {
                fetch(`/debate/ajax/search?q=${encodeURIComponent(query)}`)
                    .then(res => res.json())
                    .then(data => {
                        resultsContainer.innerHTML = '';

                        if (data.length === 0) {
                            resultsContainer.innerHTML = '<div class="no-result">Aucun d√©bat trouv√©</div>';
                        } else {
                            data.forEach(debat => {
                                const item = document.createElement('a');
                                item.href = `/debate/${debat.id}`;
                                item.classList.add('search-item');
                                item.textContent = debat.nameDebate;
                                resultsContainer.appendChild(item);
                            });
                        }

                        resultsContainer.style.display = 'block';
                    });
            }, 100);
        });

        form.addEventListener('submit', function (e) {
            const resultItems = resultsContainer.querySelectorAll('.search-item');
            if (resultItems.length === 0) {
                e.preventDefault();
                alert("Aucun d√©bat trouv√©. Veuillez s√©lectionner une suggestion.");
            } else if (resultItems.length === 1) {
                e.preventDefault();
                window.location.href = resultItems[0].href;
            }
        });

        input.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                const resultItems = resultsContainer.querySelectorAll('.search-item');
                if (resultItems.length === 0) {
                    e.preventDefault();
                    alert("Aucun d√©bat trouv√©. Veuillez s√©lectionner une suggestion.");
                }
            }
        });
    });

    document.addEventListener('click', (e) => {
        const searchContainer = document.querySelector('.navbar__search');
        const langSwitcher = document.getElementById('lang-switcher');
        const langIcon = document.querySelector('.lang-icon');

        // Si clic en dehors de la recherche et pas sur le switcher langue ou ic√¥ne langue
        if (!searchContainer.contains(e.target) &&
            !langSwitcher.contains(e.target) &&
            !langIcon.contains(e.target)) {
            resultsContainer.innerHTML = '';
            resultsContainer.style.display = 'none';
        }
    });

</script>
