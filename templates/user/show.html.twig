{% extends 'base.html.twig' %}

{% block title %}Profil utilisateur{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/user.css') }}">
    <link rel="stylesheet" href="{{ asset('css/Debate/debate.css') }}">
{% endblock %}

{% block body %}
<div class="page">
    <div class="profile_info">
        <h2>Vos informations</h2>

        <div id="displayFields">
            <p><strong>Pseudo :</strong> {{ user.pseudo }}</p>
            <p><strong>Adresse email :</strong> {{ user.email }}</p>
            {# <p><strong>Mot de passe :</strong> {{ user.password }}</p> #}
        </div>

        <form method="POST" action="{{ path('app_user_edit', {'id': user.id}) }}" id="editForm" class="hidden">
            <div class="editable">
                <label>Pseudo:</label>
                <input type="text" name="pseudo" value="{{ user.pseudo }}">
            </div>
            <div class="editable">
                <label>Adresse email:</label>
                <input type="email" name="email" value="{{ user.email }}">
            </div>
            {# <div class="editable">
                <label>Mot de passe:</label>
                <input type="password" name="password" value="{{ user.password }}">
            </div> #}
            <div class="bouton">
                <button type="submit" class="button button-enregistrer">Enregistrer</button>
            </div>
        </form>

        <p><strong>Compte créé le :</strong> {{ user.createdDate ? user.createdDate|date('d/m/Y') : '' }}</p>

        <div class="bouton">
            <button type="button" class="button button-modifier" id="logoutButton" onclick="window.location.href='{{ path('app_logout') }}'">Déconnexion</button>
            <button type="button" class="button button-modifier" id="editButton" onclick="toggleEdit()">Modifier</button>
            <button type="button" class="button button-supprimer" onclick="confirmDelete()">Supprimer</button>
        </div>
    </div>

    <div class="div_stat">
        <div class="recent_debat scrollable-debates">
            <h2>Débats récents</h2>
            <div class="scroll-container">
                {% for debat in recentDebates %}
                    {% set statsR = statDebates[debat.id] ?? {
                        'nb_vote_camp_1': 0,
                        'nb_vote_camp_2': 0,
                        'pourcentage_camp_1': 50,
                        'pourcentage_camp_2': 50,
                        'nb_participants': 0
                    } %}
                    <a href="{{ path('app_debate_show', {'id': debat.id}) }}" class="debate-item">
                        <div class="debat">
                            <h3>{{ debat.nameDebate }}</h3>
                            <div class="debate-description">{{ debat.descriptionDebate }}</div>
                            <div class="progress-container">
                                {% if statsR.pourcentage_camp_1 > 0 %}
                                    <div class="progress-blue" style="width: {{ statsR.pourcentage_camp_1 }}%;">
                                        {{ statsR.pourcentage_camp_1 }}%
                                    </div>
                                {% endif %}
                                {% if statsR.pourcentage_camp_2 > 0 %}
                                    <div class="progress-red" style="width: {{ statsR.pourcentage_camp_2 }}%;">
                                        {{ statsR.pourcentage_camp_2 }}%
                                    </div>
                                {% endif %}
                            </div>
                            <div class="debate-stats">{{ statsR.participants ?? 0 }} participants</div>
                        </div>
                    </a>
                {% else %}
                    <p>Aucun débat récent trouvé.</p>
                {% endfor %}
            </div>
        </div>

        

        <div class="statistique">
            <h2>Statistiques</h2>
            {% if stats is defined %}
                <p><strong>Nombre total de votes accumulés :</strong> {{ stats.total_votes ?? 0 }}</p>
                <p><strong>Débat remporté :</strong> {{ stats.debates_won ?? 0 }} Victoires</p>
                <p class="highlight">Classement mois en cours : {{ stats.rank_month ?? 'Non classé' }}</p>
                <p><strong>Classement global :</strong> {{ stats.rank_global ?? 'Non classé' }}</p>
            {% else %}
                <p>Aucune statistique disponible pour cet utilisateur.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function toggleEdit() {
        const displayFields = document.getElementById('displayFields');
        const editForm = document.getElementById('editForm');
        const editButton = document.getElementById('editButton');

        displayFields.classList.toggle('hidden');
        editForm.classList.toggle('hidden');

        if (!editForm.classList.contains('hidden')) {
            editButton.textContent = "Annuler";
            editButton.classList.remove('button-modifier');
            editButton.classList.add('button-supprimer');
        } else {
            editButton.textContent = "Modifier";
            editButton.classList.remove('button-supprimer');
            editButton.classList.add('button-modifier');
        }
    }

    function confirmDelete() {
        const confirmation = confirm("Si vous acceptez la suppression, vous serez redirigé vers la page d'accueil.");
        if (confirmation) {
            window.location.href = "{{ path('app_user_delete', {'id': user.id}) }}";
        }
    }
</script>
{% endblock %}
